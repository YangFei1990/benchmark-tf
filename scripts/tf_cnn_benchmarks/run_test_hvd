#!/bin/bash

set -e
TF_BENCHMARKS_DIR="benchmarks"
TF_MODELS_DIR="models"
COCO_API_DIR="coco/cocoapi"

# run benchmark

export PYTHONPATH=`pwd`/${TF_MODELS_DIR}:`pwd`/${TF_MODELS_DIR}/research:`pwd`/${COCO_API_DIR}/PythonAPI:$PYTHONPATH

# start timing
start=$(date +%s)
start_fmt=$(date +%Y-%m-%d\ %r)

python -c 'import tensorflow; print(tensorflow.__version__)'
python -c 'import tensorflow; print(tensorflow.__git_version__)'

mpirun -np 8 \
    -H localhost:8 \
    -bind-to none -map-by slot \
    -x NCCL_DEBUG=INFO -x LD_LIBRARY_PATH -x PATH \
    -mca pml ob1 -mca btl ^openib \
python $HOME/${TF_BENCHMARKS_DIR}/scripts/tf_cnn_benchmarks/tf_cnn_benchmarks.py \
  --model=ssd300 \
  --data_name=coco \
  --data_dir=/home/ubuntu/coco \
  --backbone_model_path=${TF_BENCHMARKS_DIR}/scripts/tf_cnn_benchmarks/resnet34_checkpoint/model.ckpt-28152 \
  --optimizer=momentum \
  --weight_decay=5e-4 \
  --momentum=0.9 \
  --num_gpus=1 \
  --batch_size=64 \
  --use_fp16 \
  --num_epochs=80 \
  --num_eval_epochs=1.9 \
  --num_warmup_batches=0 \
  --eval_during_training_at_specified_steps='7500,10000,11250,12500,12707,15000' \
  --variable_update=horovod \
  --gradient_repacking=2 \
  --stop_at_top_1_accuracy=0.212 \
  --ml_perf_compliance_logging \
  --loss_type_to_report=base_loss  \
  --single_l2_loss_op \
  --compute_lr_on_cpu \
  --xla=True  \
  --datasets_num_private_threads=8 \
  --train_dir="$HOME/${TF_BENCHMARKS_DIR}/scripts/tf_cnn_benchmarks/train_dir"


# end timing
end=$(date +%s)
end_fmt=$(date +%Y-%m-%d\ %r)
echo "ENDING TIMING RUN AT $end_fmt"

# report result
result=$(( $end - $start ))
result_name="ssd"


echo "RESULT,$result_name,0,$result,$USER,$start_fmt"
